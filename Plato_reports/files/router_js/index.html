<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - router.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>router.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">86.09</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">259</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">21.06</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">1.46</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">/**
 * Router module - Main Application.
 * @module router
 */
// requires all the modules dependencies
const express = require(&#039;express&#039;);
const ahl = express();
const http = require(&#039;http&#039;).createServer(ahl);
const port = process.env.PORT || 3000;
const path = require(&#039;path&#039;);
const exphbs = require(&#039;express-handlebars&#039;);


//creates a backport for the socket communication
const backport = require(&#039;socket.io&#039;)(http);

//publish CSS, client JS and images
ahl.use(express.static(path.join(__dirname,&#039;/public&#039;)));

//refers different paths for every component
ahl.set(&#039;controllers&#039;,path.join(__dirname,&#039;controllers&#039;));
ahl.set(&#039;models&#039;,path.join(__dirname,&#039;models&#039;));
ahl.set(&#039;views&#039;,path.join(__dirname,&#039;views&#039;));


// sets up the handlebars view engine
const partialsLocation = path.join(__dirname,&#039;views/partials&#039;);
const layoutsLocation = path.join(__dirname,&#039;views/layouts&#039;);
ahl.engine(&#039;.hbs&#039;, exphbs({
    extname: &#039;hbs&#039;,
    layoutsDir: layoutsLocation,
    partialsDir: partialsLocation,
    defaultLayout: &#039;main&#039;
}));
ahl.set(&#039;view engine&#039;,&#039;.hbs&#039;);

// initialize all the 3 controller
const fileExplorerController = require(&#039;./controllers/fileExplorerController&#039;);
const loadingController = require(&#039;./controllers/loadingController&#039;);
const editController = require(&#039;./controllers/editController&#039;);

const pages = {
    fileExplorer: fileExplorerController,
    loading: loadingController,
    edit: editController
}

let activePage = pages.fileExplorer;
const getActive = () =&gt; {
    return activePage;
};

//sets up all the routes
ahl.get(&#039;/&#039;,(req,res) =&gt;{
    console.log(&quot;Requested /&quot;)
    getActive().getBody(res);
});

ahl.all(&#039;/toFileExplorer&#039;,(req,res) =&gt; {
    console.log(&#039;called toFileExplorer&#039;);
    activePage = pages.fileExplorer;
    res.send(&#039;&#039;);
    backport.emit(&#039;refresh&#039;,&#039;&#039;);
});

ahl.all(&#039;/toLoading&#039;,(req,res) =&gt; {
    console.log(&#039;called toLoading&#039;);
    activePage = pages.loading;
    res.send(&#039;&#039;);
    backport.emit(&#039;refresh&#039;,&#039;&#039;);
    // setTimeout(() =&gt; {
    //     activePage = pages.edit;
    //     backport.emit(&#039;refresh&#039;,&#039;&#039;);
    // },10000)
});

ahl.all(&#039;/toEdit&#039;,(req,res) =&gt; {
    console.log(&#039;called toEdit&#039;);
    activePage = pages.edit;
    res.send(&#039;&#039;);
    backport.emit(&#039;refresh&#039;,&#039;&#039;);
});

// associate connection events to messages emit
backport.on(&#039;connection&#039;, (socket) =&gt; {
    console.log(&#039;user connected to io&#039;);
    socket.on(&#039;disconnect&#039;, () =&gt; {
        console.log(&#039;user disconnected from io&#039;);
    })
});

//puts the server listening on the correct port
http.listen(port, function(){
    console.log(&#039;listening on *:&#039; + port);
});

/**
 * All&#039;accesso all&#039;API getTable() la function restituisce l’oggetto XHTML
 * rappresentante la tabella delle label aggiornata tramite la
 * updateLabelTable() dell’editController.
 * @param {object} req - Rappresenta la richiesta http
 * @param {object} res - Rappresenta la risposta http
 */
ahl.post(&#039;/getTable&#039;, (req,res) =&gt; {
    editController.updateLabelTable(res);
});

/**
 * All&#039;accesso all&#039;API selectFile(fileKey) la function  ​richiede al File Explorer Controller
 * di effettuare la scelta del file in base alla filekey ricevuta in POST in formato json.
 * @param {object} req - Rappresenta la richiesta http contenente la fileKey
 * @param {object} res - Rappresenta la risposta http
 */
ahl.post(&#039;selectFile&#039;, (req,res) =&gt; {
    res.send(fileExplorerController.launchFileProcessing(req.body[&#039;fileKey&#039;]));
});

/**
 *  ​Notifica il client tramite il socket che una riga
 *  della tabella dei riconoscimenti è stata cambiata.
 * @param {object} req - Rappresenta la richiesta http contenente la fileKey
 * @param {object} res - Rappresenta la risposta http
 */
ahl.post(&#039;notifyLabelRowChange&#039;, (req,res) =&gt; {
    res.send(backport.emit(&#039;changedRow&#039;,req.body[&#039;rowIndex&#039;]));
});

/**
 *  Seleziona la label indicata tramite HTTP POST come
 *  parametro sfruttando la funzione checkLabel(labelIndex)
 *  dell’editController.
 * @param {object} req - Rappresenta la richiesta http contenente la labelIndex
 * @param {object} res - Rappresenta la risposta http
 */
ahl.post(&#039;includeLabel&#039;, (req,res) =&gt; {
    res.send(fileExplorerController.checkLabel(req.body[&#039;rowIndex&#039;]));
});

/**
 *  Deseleziona la label indicata tramite HTTP POST come
 *  parametro sfruttando la funzione uncheckLabel(labelIndex)
 *  dell’editController.
 * @param {object} req - Rappresenta la richiesta http contenente la labelIndex
 * @param {object} res - Rappresenta la risposta http
 */
ahl.post(&#039;includeLabel&#039;, (req,res) =&gt; {
    res.send(fileExplorerController.uncheckLabel(req.body[&#039;rowIndex&#039;]));
});

/**
 * All&#039;accesso all&#039;API getVideoFrame() la function restituisce l’oggetto XHTML
 * rappresentante il frame video aggiornato tramite la funzione
 * updateVideoFrame() dell’editController.
 * @param {object} req - Rappresenta la richiesta http
 * @param {object} res - Rappresenta la risposta http
 */
ahl.post(&#039;/getVideoFrame&#039;, (req,res) =&gt; {
    editController.updateVideoFrame(res);
});

/**
 *  ​API che si occupa dell’inoltro delle informazioni delle label passate tramite HTTP POST
 *  come parametro sfruttando la funzione addNewLabelRow(start, duration, modelIndex).
 * @param {object} req - Rappresenta la richiesta http contenente il dizionario con start, duration e model index
 * @param {object} res - Rappresenta la risposta http
 */
ahl.post(&#039;addLabel&#039;, (req,res) =&gt; {
    const reqDict=req.body;
    res.send(editController.addNewLabelRow(reqDict[&#039;start&#039;],reqDict[&#039;duration&#039;],reqDict[&#039;modelIndex&#039;]));
});

/**
 *  ​API che si occupa della notifica dell&#039;intenzione da parte dell&#039;utente di voler
 *  cambiare la modalità di visualizzazione del video in base al parametro toOriginal
 * @param {object} req - Rappresenta la richiesta http contenente il valore booleano toOriginal
 * @param {object} res - Rappresenta la risposta http
 */
ahl.post(&#039;setVideoMode&#039;, (req,res) =&gt; {
    res.send(editController.changeVideoMode(req.body[&#039;toOriginal&#039;]));
});

/**
 *  ​API che si occupa della notifica del client tramite il socket
 *  che il processo di montaggio è stato concluso correttamente o negativamente.
 * @param {object} req - Rappresenta la richiesta http contenente il booleano done
 * @param {object} res - Rappresenta la risposta http
 */
ahl.post(&#039;notifyEditingFinish&#039;, (req,res) =&gt; {
    res.send(backport.emit(&#039;finish&#039;, req.body[&#039;done&#039;]));
});

/**
 *  ​API che si occupa della notifica del client tramite il socket
 *  che la lista dei files è cambiata.
 * @param {object} req - Rappresenta la richiesta http
 * @param {object} res - Rappresenta la risposta http
 */
ahl.post(&#039;notifyChangedFileList&#039;, (req,res) =&gt; {
    res.send(backport.emit(&#039;changeFile&#039;,&#039;&#039;));
});

/**
 *  ​API che si occupa dell&#039;inoltro della richiesta di conferma
 *  del gradimento dello stato attuale della tabella dei riconoscimenti
 *  tramite la funzione confirmEditing() dell’editController.
 * @param {object} req - Rappresenta la richiesta http
 * @param {object} res - Rappresenta la risposta http
 */
ahl.post(&#039;confirmEdit&#039;, (req,res) =&gt; {
    res.send(editController.confirmEditing());
});

// /** TODO remove from the Dev Manual
//  * All&#039;accesso all&#039;API getProgressionBar() la function restituisce l’oggetto XHTML
//  * rappresentante la  la progress bar aggiornata tramite la
//  * funzione getUpdatedBar() del loadingController.
//  * @param {object} req - Rappresenta la richiesta http
//  * @param {object} res - Rappresenta la risposta http
//  */
// ahl.post(&#039;getProgressionBar&#039;, (req,res) =&gt; {
//     loadingController.getUpdatedBar(res);
// });

/**
 *  ​API che si occupa della ​notifica del client tramite il socket
 *  che il livello di progressione è cambiato ricevendo in
 *  POST il valore percentuale. Nel caso la progressione sia ultimata, modifica la active page
 *  e notifica il client
 * @param {object} req - Rappresenta la richiesta http contenente il valore intero progress
 * @param {object} res - Rappresenta la risposta http
 */
ahl.post(&#039;notifyProgressionUpdate&#039;, (req,res) =&gt; {
    res.send(backport.emit(&#039;progress&#039;,req.body[&#039;progress&#039;]));
    if (progression &gt;= 100){
        activePage = pages.edit;
        backport.emit(&#039;refresh&#039;,&#039;&#039;);
    }
});

/**
 * All&#039;accesso all&#039;API getFileList() la function restituisce l’oggetto XHTML
 * rappresentante il frame contenente tutti i tiles dei video da elaborare tramite
 * la funzione getUpdatedFileList() del fileExplorerController
 * @param {object} req - Rappresenta la richiesta http
 * @param {object} res - Rappresenta la risposta http
 */
ahl.post(&#039;/getFileList&#039;, (req,res) =&gt; {
    fileExplorerController.getUpdatedFileList(res);
});

/**
 *  ​API che si occupa della notifica del client tramite il socket
 *  che è stato cambiato correttamente l&#039;endpoint video.
 * @param {object} req - Rappresenta la richiesta http contenente il booleano done
 * @param {object} res - Rappresenta la risposta http
 */
ahl.post(&#039;notifyNewVideoEndpoint&#039;, (req,res) =&gt; {
    res.send(backport.emit(&#039;newEndpoint&#039;, req.body[&#039;done&#039;]));
});</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ cyclomatic }} <br>
    Length : {{ halstead.length }} <br>
    Difficulty : {{ halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
